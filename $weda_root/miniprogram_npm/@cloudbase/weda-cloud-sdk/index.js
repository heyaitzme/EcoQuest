/*!
 * @cloudbase/weda-cloud-sdk
 * Copyright© 2024 Tencent
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@isaacs/ttlcache"),require("mobx"),require("@cloudbase/adapter-interface"),require("@cloudbase/auth")):"function"==typeof define&&define.amd?define(["exports","@isaacs/ttlcache","mobx","@cloudbase/adapter-interface","@cloudbase/auth"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CloudSDK={},e.TTLCache,e.mobx,e.adapterInterface,e.tcbauth)}(this,(function(e,t,n,r,o){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=i(t);function a(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}function c(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function u(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function l(e,t,n,r,o){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?o.call(e,n):o?o.value=n:t.set(e,n),n}class d extends Error{constructor(e,t,n){super(t),this.code=e,this.name="TCBError",this.original=n}}function f(e,t){return!!e&&Object.prototype.hasOwnProperty.call(e,t)}const p={};let h;function g(e){if(!h)throw new Error("app config not inited");return e?h[e]:h}function m(){}function v(e){h=Object.assign(h||{},e)}function y(e){return!e&&h.useLegacyDatasource?"lcap-common-service":"lowcode-datasource"+(h.isProd?"":"-preview")}function w(e,t){return e.length===t.length&&e.every(((e,n)=>e===t[n]))}const I=[];function S(e,...t){const n=I.find((n=>n[0]===e&&w(n[1],t)));if(n)return n[2];const r=e(...t);return I.push([e,t,r]),r}function O(e,t){if(!e)return e;return t.reduce(((t,n)=>(f(e,n)&&(t[n]=e[n]),t)),{})}const _={};function b(e,t){_[e]=t}function x(e,t){const n=_[e];return n&&"function"==typeof n?n(t):n}function A(){return"tcb-api"===g("endpointType")}function T(e){const t=e=>({status:"fulfilled",value:e}),n=e=>({status:"rejected",reason:e});return Promise.all(e.map((e=>Promise.resolve(e).then(t,n))))}function P(e){return"string"==typeof e}function D(e){return"[object Object]"===Object.prototype.toString.call(e)}const E=e=>{const t=t=>{for(const n in e)e.hasOwnProperty(n)&&(t[n]=E(e[n]));return t},n=null==e?"NullOrUndefined":Object.prototype.toString.call(e).slice(8,-1);if(["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"].includes(n))return e.slice();switch(n){case"Object":return t(Object.create(Object.getPrototypeOf(e)));case"Array":return t([]);case"Date":return new Date(e.valueOf());case"RegExp":return new RegExp(e.source,`${e.global?"g":""}${e.ignoreCase?"i":""}${e.multiline?"m":""}${e.sticky?"y":""}${e.unicode?"u":""}`);default:return e}};function U(e){const t=g("datasetProfiles");return e?t[e]:t}class C{constructor(e){this.localStorage=(null==e?void 0:e.localStorage)||globalThis.localStorage}getItem(e){return c(this,void 0,void 0,(function*(){return this.localStorage.getItem(e)}))}removeItem(e){return c(this,void 0,void 0,(function*(){this.localStorage.removeItem(e)}))}setItem(e,t){return c(this,void 0,void 0,(function*(){this.localStorage.setItem(e,t)}))}getItemSync(e){return this.localStorage.getItem(e)}setItemSync(e,t){this.localStorage.setItem(e,t)}removeItemSync(e){this.localStorage.removeItem(e)}}const N=/^[^:]+:\/\/[^/]+(\/[^?#]+)/;function k(e){if(e)return function(t,n){var r;return c(this,void 0,void 0,(function*(){let o;const i=null===(r=null==n?void 0:n.headers)||void 0===r?void 0:r["x-request-id"];try{const r=Object.assign({},n);r.body&&"string"!=typeof r.body&&(r.body=JSON.stringify(r.body)),o=yield e(Object.assign(Object.assign({},r),{url:t,method:r.method||"GET"})),o.code&&(o={error:o.code,error_description:o.message||o.code,request_id:o.requestId})}catch(e){o={error:"unreachable",error_description:e.message}}if(o.request_id||(o.request_id=i),o.error)throw o.error_uri=$(t),o;return o}))}}function $(e){return N.test(e)?RegExp.$1:e}function j(e,t){return c(this,void 0,void 0,(function*(){if(e.privatelink){let n;if(e.getPrivatelinkAdapter){const t=yield e.getPrivatelinkAdapter();t&&(n=t)}else try{n="undefined"!=typeof window?window.tcbAdapterPrivatelink:void 0}catch(e){}return(null==n?void 0:n.generateAdapterWithConfig)?n.generateAdapterWithConfig({__privatelink_config__:Object.assign({pathname:"/tcb_private_link"},e.privatelink),__tcbAPIEdnpointReg__:t?new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")):void 0}):void 0}}))}const R={},M={},F={},L={on(e,t){R[e]&&console.warn(`event ${e} has been registered`),R[e]=t},once(e,t){if(F[e])return F[e].push(t);F[e]=[t]},emit(e,...t){return c(this,void 0,void 0,(function*(){R[e]&&R[e](...t),F[e]&&(F[e].forEach((e=>e(...t))),F[e]=[])}))},off(e){Array.isArray(e)?e.forEach((e=>delete R[e])):delete R[e]},listen(e,t){M[e]||(M[e]=[]),M[e].includes(t)||M[e].push(t)},broadcast(e,...t){const n=M[e];n&&0!==n.length&&n.forEach((e=>{try{e(...t)}catch(e){}}))},quit(e,t){const n=M[e];if(!n||0===n.length)return;const r=n.indexOf(t);r>-1&&n.splice(r,1)}};function q(e,t){const n=e.split(".");if(2!==n.length)return void console.warn("[weda-cloud-sdk]setStateVar: invalid varPath",e);let r=n[0];if("$page"===r){const e=g("currentPageId");if(!e||"$global"===e)return void console.warn("[weda-cloud-sdk]setStateVar: can not find currentPageId",r);r=e}const o=p[r],i=n[1];if(o&&(f(o.state.$status,i)||f(o.state,i))){if(o.state.$status[i]){if(t instanceof Error)return void(o.state.$status[i]={status:"failed",code:t.code||-1,message:t.message,error:t});"success"!==o.state.$status[i].status&&(o.state.$status[i]={status:"success"})}o.state[i]=t}}const W={setState:q,setParams:function(e,t){const n=(g("datasetProfiles")||{})[e],r=p[e];if(!r||!n||!n.params)return;const o=O(t,Object.keys(n.params));r.params||(r.params={}),Object.entries(o).forEach((([e,t])=>{r.params[e]=t}))},EVENT_BUS:L},V={tempURLMaxWaitGap:50};function B(e){Object.assign(V,e)}function z(){return"undefined"!=typeof window&&window||"undefined"!=typeof globalThis&&globalThis}function G(){try{const e=z();if(!e)return;return"undefined"==typeof wx?z().location.href:e.__wxRoute}catch(e){}}function K(){const e=z();if(null==e?void 0:e.navigator)return e.navigator.userAgent;if("undefined"!=typeof wx&&wx.getSystemInfo){let e;return wx.getSystemInfo({success(t){t&&(e=["brand","model","version","system","platform","SDKVersion","language"].map((e=>`${e}: ${t[e]}`)).join(", "))}}),e}}!function(){try{if(B({userAgent:K()}),"undefined"!=typeof window&&window&&window.top){const e=window.__wconfig||top.location.search,t={};if(/\b__wedaTarget=([^&]+)/.test(e)){const e=decodeURIComponent(RegExp.$1);e&&(t.wedaTarget=e)}/\b__useLegacy=true\b/.test(e)&&(t.useLegacyDatasource=!0),v(t)}}catch(e){}}();const J="$CLOUD_SDK_VERSION$";function H(e,t){if("OPERATION_FAIL"===e.code||/OPERATION_FAIL/.test(e.message)){if(/FUNCTION_NOT_FOUND/.test(e.message)){const n=(null==t?void 0:t.FUNCTION_NOT_FOUND)||"找不到数据源的云函数";return new d("FUNCTION_NOT_FOUND",n,e)}if(/FUNCTIONS_EXECUTE_FAIL/.test(e.message)){const n=(null==t?void 0:t.FUNCTIONS_EXECUTE_FAIL)||"云函数执行失败";return new d("FUNCTIONS_EXECUTE_FAIL",n,e)}}if(/network request error/.test(e.message))return new d("NETWORK_ERROR","网络故障, 请检查本地网络连接是否正常",e);if(/method .* not found in datasource/i.test(e.message)){const n=(null==t?void 0:t.DS_METHOD_NOT_FOUND)||"找不到数据源的方法";return new d("DS_METHOD_NOT_FOUND",n,e)}return(null==t?void 0:t.DEFAULT_ERROR)?new d(e.code||"DEFAULT_ERROR",t.DEFAULT_ERROR,e):e}let X=new Map;const Q=["wedaGetItem","wedaGetRecords","wedaGetItemV2","wedaGetRecordsV2","getApiKey"],Y=["callWedaApi"];function Z(){return c(this,void 0,void 0,(function*(){const e=g("initTcb"),{app:t}=yield e();return t}))}function ee(e){var t,n;return c(this,void 0,void 0,(function*(){const r="boolean"!=typeof e.parseBusinessInfo||e.parseBusinessInfo,o=Object.assign({},e),i=o.name||o.dataSourceName,{methodName:s}=o,a={params:o.params,methodName:s},c=(e=>{if(e&&Object.keys(e).length)return Object.assign({swrMode:!0},e)})(null===(t=o.params)||void 0===t?void 0:t.swr);delete o.name,delete o.parseBusinessInfo,(null===(n=o.params)||void 0===n?void 0:n.swr)&&delete o.params.swr;const u=Object.assign(o.extraParams||{},{dataSourceName:i,methodName:s,defaultParams:x(i,a),params:o.params});try{const e=g("customCallDataSource");if(e){return yield e(Object.assign({},u,{parseBusinessInfo:r}))}const t=g("beforeDSRequest");t&&t(o);const n=yield ne({name:y(!0),data:u},{unwrapResult:!0,parseBusinessInfo:r,swr:c}),i=g("afterDSRequest");return i&&i(o,null,n),n}catch(e){if(console.warn(`[weda-cloud-sdk] failed to invoke datasource ${i}'s method ${s}`,e),r){const t=H(e,{FUNCTION_NOT_FOUND:`找不到数据源${i}的云函数`,DS_METHOD_NOT_FOUND:`数据源${i}中的方法${s}不存在或者未启用`,FUNCTIONS_EXECUTE_FAIL:`调用数据源${i}方法${s}失败: 请检查该数据源所有自定义方法的代码中是否存在语法错误`,DEFAULT_ERROR:`调用数据源${i}方法${s}失败: ${e.errMsg||e.message}`}),n=g("afterDSRequest");throw n&&n(o,t),t}return{code:e.errCode||-2,message:`调用数据源${i}方法${s}失败: ${e.errMsg||e.message}`}}}))}function te(e,t){return new Proxy({},{get(n,r){if(t){const e=t(r);if(e)return e}return new Proxy({},{get:(t,n)=>(t,o)=>ee({name:r,methodName:n,extraParams:o,params:t,parseBusinessInfo:e})})}})}function ne(e,t){var n,r;return c(this,void 0,void 0,(function*(){let o=E(e);const i=g("initTcb"),s=g("isProd"),a={wedaAppId:g("appID"),userAgent:V.userAgent,referrer:G(),envType:s?"prod":"pre",wedaTarget:g("wedaTarget"),"x-cloud-sdk-version":J};o.data=Object.assign({},o.data,a);let u=null==t?void 0:t.app;if(!u){u=(yield i()).app}const l=g("beforeCallFunction");let f;l&&(o=yield l(o));const p=g("afterCallFunction");try{if(o=ie(o),(e=>{const{methodName:t}=(null==e?void 0:e.data)||{};Q.includes(t)||Y.includes(t)||(X=new Map)})(o),f=(null===(n=null==t?void 0:t.swr)||void 0===n?void 0:n.swrMode)?yield((e,t,n={},r)=>c(void 0,void 0,void 0,(function*(){const{cacheTime:o}=n||{},{methodName:i,dataSourceName:s,action:a}=e.data||{},c=o||2e4,u=r||`${i}_${s||a}`,l=JSON.stringify(e),d=X.get(u)||new Map;n.forceClear&&d.delete(l);const f=d.get(l)||{value:null,time:0,promise:null};return d.set(l,f),X.set(u,d),Date.now()-f.time>c&&!f.promise?f.promise=t(e).then((e=>{f.value=e,f.time=Date.now(),f.promise=null})).catch((e=>{f.value=e,f.time=Date.now()-c,f.promise=null})):f.promise||f.value,f.promise&&!f.value&&(yield f.promise),f.value})))(o,u.callFunction.bind(u),null==t?void 0:t.swr):yield u.callFunction(o),p&&p(o,null,JSON.parse(JSON.stringify(f))),(null===(r=null==t?void 0:t.swr)||void 0===r?void 0:r.swrMode)&&(null==f?void 0:f.error))throw f}catch(e){throw p&&p(o,e),e}if(null==t?void 0:t.unwrapResult){const{result:e}=f;if(!t.parseBusinessInfo)return e;if(!e.code)return e.data;throw console.warn("[weda-cloud-sdk]failed to invoke backend, %c调用后端接口失败, 请仔细查看下述错误信息:","color: red;"),console.warn(`\tcode: ${e.code}\n\tmessage: ${e.message}\n\treason: ${e.reason}\n\trequestId: ${f.requestId}\n\toriginal response: `,f),new d(e.code,e.message,f)}return f}))}const re=["wedaGetRecords","wedaGetItem"],oe=["wedaUpdateV2","wedaBatchUpdateV2","wedaGetItemV2","wedaGetRecordsV2","wedaDeleteV2","wedaBatchDeleteV2"],ie=e=>{try{const{methodName:t,params:n={}}=(null==e?void 0:e.data)||{};n.hasOwnProperty("where")&&re.includes(t||"")&&(n.where=se(n.where)),n.hasOwnProperty("filter")&&oe.includes(t||"")&&(n.filter=se(n.filter))}catch(e){}return e},se=e=>{let t;return Array.isArray(e)?(t=t||[],e.forEach((e=>{const n=se(e);void 0!==n&&t.push(n)})),t):D(e)?(Object.keys(e).forEach((n=>{const r=se(e[n]);void 0!==r&&(t=t||{},t[n]=r)})),t):e},ae=e=>{if(e&&Object.keys(e).length)return Object.assign({swrMode:!0},e)};function ce(e,t){return c(this,void 0,void 0,(function*(){const n=E(e),r=E(n.swr||{});return delete n.swr,ne({name:y(),data:Object.assign(Object.assign({},n),{mode:"c"})},{app:t,unwrapResult:!0,parseBusinessInfo:!0,swr:r}).catch((e=>{throw H(e,{FUNCTION_NOT_FOUND:"微搭环境异常: 未找到数据源公共云函数",FUNCTIONS_EXECUTE_FAIL:"微搭环境异常: 数据源公共云函数调用失败"})}))}))}function ue(e){return c(this,void 0,void 0,(function*(){const t=E(e);return e&&delete t.swr,ce({methodName:"callWedaApi",params:t,swr:ae(null==e?void 0:e.swr)}).then((e=>e.Data))}))}const le={_:[]};function de(e){return JSON.parse(JSON.stringify(e))}const fe={wrapperDatasourceMethod:e=>function(t){return ee({name:e.dataSourceName,methodName:e.methodName,params:t})}},pe=new s.default({max:1e3,ttl:2e4,checkAgeOnGet:!0});let he=[],ge=[],me=[];let ve=0,ye=0;function we(){return c(this,void 0,void 0,(function*(){const e=ge.splice(0);he=he.concat(e);try{const t=g("initTcb"),{app:n}=yield t(),r=(yield T(function(e,t){const n=[];for(let r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}(e,40).map((e=>n.getTempFileURL({fileList:e}))))).filter((e=>"fulfilled"===e.status));he=he.filter((t=>!e.includes(t)));const o=r.reduce(((e,t)=>{const n=t.value||{};return n.code&&"SUCCESS"!==n.code?(console.warn("[cloud.getTempFileURL]server response error",n),e):e.concat(n.fileList)}),[]);if(!o.length)return void Ie({},e);const i={},s=[];o.forEach((e=>{var t;(f(t=e,"code")?"SUCCESS"===t.code:f(t,"status")&&!t.status)?i[e.fileID]=e.tempFileURL:(console.warn("[cloud.getTempFileURL]single item failed",e),s.push(e.fileID))})),Ie(i,s)}catch(t){he=he.filter((t=>!e.includes(t))),console.warn("[cloud.getTempFileURL] request failed",t),Ie({},e)}}))}function Ie(e,t){Object.keys(null!=e?e:{}).forEach((t=>{pe.set(t,e[t])})),me.forEach((e=>{const n=Se(e.fileIds,t);!1!==n&&(e.resolve(n),e.isDone=!0)})),me=me.filter((e=>!e.isDone))}function Se(e,t=[]){try{if(Array.isArray(e)){const n={};return e.reduce(((e,n)=>{const r=pe.get(n);if(!r){if(t.includes(n))return e;throw new Error("not found")}return e[n]=r,e}),n)}const n=pe.get(e);if(!n){if(t.includes(e))return;throw new Error("not found")}return n}catch(e){return!1}}const Oe=te(!1,(e=>{if("$call"===e)return e=>ee(Object.assign({},e,{parseBusinessInfo:!1}))})),_e={dataSources:te(!0),callDataSource:ee,callConnector:ee,callModel:ee,IS_WEDA_IDE:!1,version:J,utils:fe,getCloudInstance:Z,callGraphql:function(e){return c(this,void 0,void 0,(function*(){try{const t=g("beforeDSRequest");t&&t(e);const n=yield ne({name:y(!0),data:{mode:"graphql",params:e}},{unwrapResult:!0}),r=g("afterDSRequest");return r&&r(e,null,n),n}catch(t){const n=g("afterDSRequest");throw n&&n(e,t),t}}))},callFunction:ne,callWorkflow:function(e){return c(this,void 0,void 0,(function*(){return ue(e)}))},callWedaApi:ue,callCommonService:ce,getTempFileURL:function(e){const t=function(e){const t=e&&"object"==typeof e&&e.fileList?e.fileList:e;return"string"==typeof t||Array.isArray(t)?t:void 0}(e);if(!t||!t.length)return Promise.resolve();const n=Se(t);return!1!==n?Promise.resolve(n):new Promise(((e,n)=>{!function(e,t,n){me.push({fileIds:e,resolve:t,reject:n});let r=(Array.isArray(e)?e:[e]).filter((e=>D(e)||P(e)));ge.length&&(r=r.filter((e=>!ge.includes(e))));r.length&&he.length&&(r=r.filter((e=>!he.includes(e))));r.length&&(r=r.filter((e=>!pe.has(e))));if(!r.length)return;ge=ge.concat(r),clearTimeout(ye);const o=Date.now();ve=!ve||o>ve?o+V.tempURLMaxWaitGap:ve,ye=setTimeout(we,ve-o)}(t,e,n)}))},getDataSourceViewId:m,getDataSourceProfile:function(e){const t=g("dataSourceProfiles");if(!t||!t.length)return void console.warn("[weda-cloud-sdk]datasource profile is empty");const n="string"==typeof e?{val:e,key:"name"}:e,r="function"==typeof n?n:e=>e&&e[n.key]===n.val;return t.find(r)},getDataSourceProfileAsync:function(e){return c(this,void 0,void 0,(function*(){const t="string"==typeof e,n=t?{Name:e}:e,r=JSON.stringify(n);if(le[r])return de(le[r]);if(t){const t=le._.find((t=>t.name===e));if(t)return de(t)}const o=g("dataSourceProfiles");if((null==o?void 0:o.length)&&t){const t=o.find((t=>t.name===e));if(t)return de(t)}const{swrMode:i}=n;delete n.swrMode;const s=function(e){const t={};Object.keys(e).reduce(((t,n)=>(t[n.charAt(0).toLowerCase()+n.slice(1)]=e[n],t)),t);const n={schema:{},methods:[]};return Object.keys(n).forEach((e=>{try{t[e]=JSON.parse(t[e])}catch(r){t[e]=n[e]}})),t}(yield ue({action:"RuntimeDescribeDataSource",data:n,swr:{swrMode:i}}));return le[r]=s,le._.push(s),de(s)}))},setConfig:B,checkAuth:function(e){return ue({action:"DescribeWedaAccessResourcesByType",data:e})},setDataSourceDefaultParams:b};function be(){if("undefined"==typeof wx)return!1;if("undefined"==typeof Page)return!1;if(!wx.getSystemInfoSync)return!1;if(!wx.getStorageSync)return!1;if(!wx.setStorageSync)return!1;if(!wx.connectSocket)return!1;if(!wx.request)return!1;try{if(!wx.getSystemInfoSync())return!1;if("qq"===wx.getSystemInfoSync().AppPlatform)return!1}catch(e){return!1}return!0}class xe extends r.AbstractSDKRequest{constructor(e={}){super();const{timeout:t,timeoutMsg:n,restrictedMethods:r}=e;this._timeout=t||0,this._timeoutMsg=n||"请求超时",this._restrictedMethods=r||["get","post","upload","download"]}post(e){const t=this;return new Promise(((n,o)=>{const{url:i,data:s,headers:a}=e,c=wx.request({url:r.formatUrl("https:",i),data:s,timeout:t._timeout,method:"POST",header:a,success(e){n(e)},fail(e){o(e)},complete(e){if(!e||!e.errMsg)return;if(!t._timeout||-1===t._restrictedMethods.indexOf("post"))return;const{errMsg:n}=e;if("request:fail timeout"===n){console.warn(t._timeoutMsg);try{c.abort()}catch(e){}}}})}))}upload(e){const t=this;return new Promise((n=>{const{url:r,file:o,data:i,headers:s}=e,a=wx.getFileSystemManager(),c=wx.request({url:r,method:e.method,header:Object.assign({"content-type":" "},s),data:a.readFileSync(o),timeout:this._timeout,success(e){const t={statusCode:e.statusCode,data:e.data||{}};200===e.statusCode&&(null==i?void 0:i.success_action_status)&&(t.statusCode=parseInt(i.success_action_status,10)),n(t)},fail(e){n(e)},complete(e){if(!e||!e.errMsg)return;if(!t._timeout||-1===t._restrictedMethods.indexOf("upload"))return;const{errMsg:n}=e;if("request:fail timeout"===n){console.warn(t._timeoutMsg);try{c.abort()}catch(e){}}}})}))}download(e){const t=this;return new Promise(((n,o)=>{const{url:i,headers:s}=e,a=wx.downloadFile({url:r.formatUrl("https:",i),header:s,timeout:this._timeout,success(e){200===e.statusCode&&e.tempFilePath?n({statusCode:200,tempFilePath:e.tempFilePath}):n(e)},fail(e){o(e)},complete(e){if(!e||!e.errMsg)return;if(!t._timeout||-1===t._restrictedMethods.indexOf("download"))return;const{errMsg:n}=e;if("request:fail timeout"===n){console.warn(t._timeoutMsg);try{a.abort()}catch(e){}}}})}))}}class Ae{constructor(e,t={}){const n=wx.connectSocket(Object.assign({url:e},t));return{set onopen(e){n.onOpen(e)},set onmessage(e){n.onMessage(e)},set onclose(e){n.onClose(e)},set onerror(e){n.onError(e)},send:e=>n.send({data:e}),close:(e,t)=>n.close({code:e,reason:t}),get readyState(){return n.readyState},CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3}}}const Te={genAdapter:function(){return{root:{},reqClass:xe,wsClass:Ae,localStorage:Pe,primaryStorage:r.StorageType.local,getAppSign(){const e=wx.getAccountInfoSync();return"undefined"!=typeof App||"undefined"!=typeof getApp||wx.onAppHide||wx.offAppHide||wx.onAppShow||wx.offAppShow?(null==e?void 0:e.miniProgram)?e.miniProgram.appId:"":(null==e?void 0:e.plugin)?e.plugin.appId:""}}},isMatch:be,runtime:"wx_mp"},Pe={setItem(e,t){wx.setStorageSync(e,t)},getItem:e=>wx.getStorageSync(e),removeItem(e){wx.removeStorageSync(e)},clear(){wx.clearStorageSync()},getKeys(){const{keys:e}=wx.getStorageInfoSync();return e||[]}};const De=new class{constructor(e){this.localStorage=(null==e?void 0:e.localStorage)||globalThis.localStorage}getItem(e){return c(this,void 0,void 0,(function*(){return this.localStorage.getItem(e)}))}removeItem(e){return c(this,void 0,void 0,(function*(){this.localStorage.removeItem(e)}))}setItem(e,t){return c(this,void 0,void 0,(function*(){this.localStorage.setItem(e,t)}))}getItemSync(e){return this.localStorage.getItem(e)}setItemSync(e,t){this.localStorage.setItem(e,t)}removeItemSync(e){this.localStorage.removeItem(e)}getKeysSync(){return this.localStorage===globalThis.localStorage?Object.keys(this.localStorage):this.localStorage.getKeys()}}({localStorage:be()?Pe:void 0});var Ee,Ue,Ce,Ne,ke,$e,je,Re,Me;Ue=new WeakMap,Ce=new WeakMap,Ne=new WeakMap,ke=new WeakMap,$e=new WeakMap,Ee=new WeakSet,je=function(e){u(this,ke,"f")===e&&(e.next?l(this,ke,e.next,"f"):e.pre&&l(this,ke,e.pre,"f")),e!==u(this,Ne,"f")&&(e.pre&&(e.pre.next=e.next),e.next&&(e.next.pre=e.pre),e.next=u(this,Ne,"f"),e.pre=null,u(this,Ne,"f")&&(u(this,Ne,"f").pre=e),l(this,Ne,e,"f"))},Re=function(e){for(;e>0&&u(this,ke,"f");){const{size:t}=u(this,ke,"f").data;u(this,Ce,"f").delete(u(this,ke,"f").data.key),u(this,ke,"f").pre?(u(this,ke,"f").pre.next=null,l(this,ke,u(this,ke,"f").pre,"f")):l(this,ke,null,"f"),e-=t,this.calculatedSize-=t}},Me=function(e,t){const n=u(this,Ce,"f").get(e,t);return(null==n?void 0:n.node)&&u(this,Ee,"m",je).call(this,null==n?void 0:n.node),n};class Fe{constructor(e,t){this.data={key:e,size:t},this.pre=null,this.next=null}}const Le=/^(?:(\d*);)?(.*)$/;function qe(e){const t=e||"";if("string"==typeof t){const e=t.match(Le);if(e)return{timestamp:Number(e[1])||0,value:e[2]}}}class We extends Map{constructor(){super()}get(e,t={}){const{refreshCache:n=!0}=t,r=super.get(e);let o=De.getItemSync(e);if(r&&o){const t=qe(o);return t&&(o=t.value,n&&De.setItem(e,`${Date.now()};${o}`)),{node:r,value:o}}}set(e,t,n={}){const{refreshCache:r=!0}=n||{},o=super.set(e,t.node);return r&&De.setItemSync(e,`${Date.now()};${t.value}`),o}delete(e){const t=super.delete(e);return De.removeItemSync(e),t}}const Ve=new class{constructor({map:e=new Map,size:t,sizeCalculation:n=(()=>1),onInit:r}){return Ee.add(this),Ue.set(this,0),Ce.set(this,void 0),Ne.set(this,void 0),ke.set(this,void 0),$e.set(this,void 0),this.calculatedSize=0,l(this,Ue,t||0,"f"),l(this,Ce,e,"f"),l(this,$e,n,"f"),this.calculatedSize=0,l(this,Ne,null,"f"),l(this,ke,null,"f"),r&&r(this),this}list(){var e;let t=u(this,Ne,"f");const n=[];for(;null==t?void 0:t.data;)n.push({key:t.data.key,value:null===(e=u(this,Ee,"m",Me).call(this,t.data.key))||void 0===e?void 0:e.value}),t=t.next;return n}get(e,t){const n=u(this,Ee,"m",Me).call(this,e,t);return null==n?void 0:n.value}set(e,t,n){var r;const o=u(this,$e,"f").call(this,t,e);if(o>u(this,Ue,"f"))return u(this,Ce,"f").delete(e),void(this.calculatedSize-=o);const i=u(this,Ee,"m",Me).call(this,e,n),s=null==i?void 0:i.node,a=o-((null===(r=null==s?void 0:s.data)||void 0===r?void 0:r.size)||0);if(s)s.data.size=o,u(this,Ce,"f").set(e,{node:s,value:t},n);else{const r=new Fe(e,u(this,$e,"f").call(this,t,e));null==u(this,Ne,"f")&&null===u(this,ke,"f")&&l(this,ke,r,"f"),r.next=u(this,Ne,"f"),u(this,Ne,"f")&&(u(this,Ne,"f").pre=r),l(this,Ne,r,"f"),u(this,Ce,"f").set(e,{node:r,value:t},n)}u(this,Ee,"m",Re).call(this,this.calculatedSize+a-u(this,Ue,"f")),this.calculatedSize=this.calculatedSize+a}delete(e){const t=u(this,Ce,"f").get(e);t&&(u(this,Ne,"f")===t.node&&l(this,Ne,t.node.next,"f"),u(this,ke,"f")===t.node&&l(this,ke,t.node.pre,"f"),t.node.pre&&(t.node.pre.next=t.node.next),t.node.next&&(t.node.next.pre=t.node.pre),t.node.pre=null,t.node.next=null,this.calculatedSize=this.calculatedSize-t.node.data.size,u(this,Ce,"f").delete(e))}}({size:2048e3,sizeCalculation:(e,t)=>`${String(e)}${String(t)}`.length,map:new We,onInit:e=>{(De.getKeysSync()||[]).filter((e=>e.startsWith("dataset_"))).map((e=>{const t=De.getItemSync(e),{value:n,timestamp:r}=qe(t)||{value:t||"",timestamp:0};return{key:e,value:n,timestamp:r}})).sort(((e,t)=>e.timestamp-t.timestamp>=0?1:-1)).forEach((({key:t,value:n})=>{e.set(t,n,{refreshCache:!1})}))}});function Be(e,t){if(!e)return;const n=Object.keys(e);if(!n.length)return{};return n.reduce(((n,r)=>{const o=e[r];return n[r]=void 0!==o.initialValue?o.initialValue:o.required?"":void 0,t&&(n[r]=o.sampleValue||n[r]),n}),{})}function ze(e,t){if(!e)return{};const n=Object.keys(e),r={},o=n.reduce(((n,o)=>{const i=e[o];if("state"!==i.varType)return n;if(i.enableSyncLocal){const e=Ge(null==t?void 0:t.appId,null==t?void 0:t.datasetProfileKey,o);e&&(r[e]=!0);try{const e=function(e,t,n,r=!0){const o=Ge(e,t,n);if(o){const e=Ve.get(o,{local:!!r});if("string"==typeof e)return JSON.parse(e)}return}(null==t?void 0:t.appId,null==t?void 0:t.datasetProfileKey,o,!1);n[o]=e}catch(e){console.error("get local state error:",e)}}return void 0===n[o]&&(n[o]=i.initialValue),n}),{});return function(e,t,n={}){const r=Ke(e,t);if(r){(De.getKeysSync()||[]).forEach((e=>{!n[e]&&e.startsWith(r)&&Promise.resolve().then((()=>{Ve.delete(e)}))}))}}(null==t?void 0:t.appId,null==t?void 0:t.datasetProfileKey,r),o}function Ge(e,t,n){const r=Ke(e,t);if(r&&n)return`${r}${n}`}function Ke(e,t){if(e&&t)return`dataset_${e}_${t}_`}function Je(e,t=!1){const{url:n}=e,r=a(e,["url"]);"PATCH"===r.method&&(r.headers||(r.headers={}),r.headers["X-HTTP-Method-Override"]="PATCH",r.method="POST"),r.body&&"string"!=typeof r.body&&(r.body=JSON.stringify(r.body,((e,t)=>{if(t&&""!==t)return t})));const o=$(n),i=n.slice(0,n.indexOf(o)),[s,c]=i.match(/:\/\/(.*)$/)||[i,i];r.headers["x-host"]=c;const u=g("envID");return{url:A()||!t?n:`${n.replace(c,"tcb-api.tencentcloudapi.com")}${-1!=n.indexOf("?")?`&env=${u}`:`?env=${u}`}`,body:r.body,method:r.method,headers:r.headers}}const He={storage:new C({localStorage:Pe}),captchaOptions:{openURIWithCallback:e=>{let t={},n=e;const r=e.match(/^(data:.*?)(\?[^#\s]*)?$/);if(r){n=r[1];const e=r[2];e&&(t=function(e){e=e.replace(/^\?/,"");const t={};return e.split("&").forEach((e=>{let[n,r]=e.split("=");n=decodeURIComponent(n),r=decodeURIComponent(r),n&&(t[n]?Array.isArray(t[n])?t[n].push(r):t[n]=[t[n],r]:t[n]=r)})),t}(e))}const{token:o}=t,i=a(t,["token"]);return/^data:/.test(n)&&!o?Promise.reject({error:"invalid_argument",error_description:`invlaie captcha data: ${e}`}):o?new Promise((e=>{console.log("wait for captcha..."),L.emit("CAPTCHA_DATA_CHANGE",Object.assign(Object.assign({},i),{token:o,url:n})),L.once("RESOLVE_CAPTCHA_DATA",(t=>{e(t)}))})):Promise.reject({error:"unimplemented",error_description:"need to impl captcha data"})}}};function Xe(e){var t,n;return c(this,void 0,void 0,(function*(){const r=yield j(g(),null===(n=null===(t=g("tcbApiOrigin"))||void 0===t?void 0:t.replace)||void 0===n?void 0:n.call(t,/^https?:\/\//,"")),{authInstance:i}=o.generateAuthInstance(Qe(e,r),{clientId:g("tcbClientId"),env:g("envID"),apiOrigin:g("tcbApiOrigin"),cache:null,platform:{runtime:(null==r?void 0:r.runtime)||Te.runtime,adapter:(null==r?void 0:r.genAdapter())||Te.genAdapter()}});return i}))}function Qe(e,t,n){let r={};if(n){const{genOauthAdaper:e=(()=>({}))}=n;r=e({generateOauthClientRequest:k,OauthClientStorgeBase:C})}const{request:o}=r,i=a(r,["request"]),s=function(e){return Object.assign({baseRequest:k(A()?e=>{const{url:t,body:n,method:r,headers:o}=Je(e,!0);return new Promise(((e,i)=>{wx.request({url:t,data:n,method:r,header:o,success(t){"object"==typeof t.data?e(t.data):i(new Error(`resp data error for - ${t.data}`))},fail(e){i(new Error(e.errMsg))}})}))}:t=>{const{url:n,method:r,headers:o,body:i}=Je(t);return e.callFunction({name:"httpOverCallFunction",data:{url:n,method:r,headers:Object.assign({origin:"https://servicewechat.com"},o),body:i}}).then((({result:e})=>e.body),(e=>{throw new Error(e.errMsg)}))})},He)}(e);return Object.assign(Object.assign(Object.assign(Object.assign({persistence:"local",region:g("region")||"ap-shanghai"},t),s),i),{baseRequest:o||s.baseRequest})}function Ye(e){return S(Xe,e)}let Ze;function et(){return c(this,void 0,void 0,(function*(){const e=g(),t=e.tcbApiOrigin?e.tcbApiOrigin.replace(/^https?:\/\//,""):"",n=yield j(e,t);let r;if(A()){const o=require("@cloudbase/js-sdk/app"),{registerAuth:i}=require("@cloudbase/js-sdk/auth"),{registerFunctions:s}=require("@cloudbase/js-sdk/functions"),{registerStorage:a}=require("@cloudbase/js-sdk/storage");i(o),s(o),a(o),o.useAdapters(n||Te),r=o.init({timeout:6e4,env:e.envID,clientId:e.tcbClientId||e.envID,region:e.region}),e.tcbApiOrigin&&o.registerEndPoint(`//${t}/web`);const c=r.auth(Qe(r,{anonymousSignInFunc:rt},n));return{app:r,auth:c}}return e.resourceAppid?(r=wx.cloud.Cloud({resourceAppid:e.resourceAppid,resourceEnv:e.envID}),yield r.init()):(r=wx.cloud,r.init({env:e.envID})),{app:r,auth:yield Ye(r)}}))}function tt(){return S(et)}function nt(){return c(this,void 0,void 0,(function*(){const{auth:e}=yield tt();let t,n;try{yield e.getAccessToken(),t=!0}catch(e){}try{n=yield e.loginScope()}catch(e){}return{notLogin:!t,isAnonymous:!t||"anonymous"===n,hasLogin:!!t&&"anonymous"!==n}}))}function rt(){return c(this,void 0,void 0,(function*(){const{auth:e}=yield tt(),{code:t}=yield wx.login(),{appId:n}=wx.getAccountInfoSync().miniProgram,{provider_token:r}=yield e.grantProviderToken({provider_id:n,provider_code:t});yield e.signInAnonymously({provider_token:r})}))}const ot="lcap-user-session",it=n.observable({currentUser:null});function st(e){return c(this,void 0,void 0,(function*(){if(it.currentUser&&!e.force)return it.currentUser;const{app:t}=yield tt(),n=yield ce({wx_phone:(null==e?void 0:e.phoneCloudID)?wx.cloud.CloudID(e.phoneCloudID):void 0,methodName:"signIn",params:e},t),r=Object.assign({},n,e,{lastUpdateTime:Date.now()});if(delete r.phoneCloudID,r.userExtend)try{const e=JSON.parse(r.userExtend);r.wxOpenId=r.wxOpenId||(null==e?void 0:e.open_id)||""}catch(e){}if(!r.wxOpenId)try{const{Data:{Data:e}}=yield ce({methodName:"callWedaApi",params:{action:"InvokeComponentWxModule",data:{Method:"GetWxContext"}}},t),n="string"==typeof e?JSON.parse(e):e;r.wxOpenId=(null==n?void 0:n.FROM_OPENID)||(null==n?void 0:n.OPENID)}catch(e){console.error("get wxcontext fail:",e)}return it.currentUser=r,wx.setStorageSync(ot,r),r}))}var at={signIn:st,signOut:function(){return c(this,void 0,void 0,(function*(){const e=yield nt(),{auth:t}=yield tt();it.currentUser=null,e.hasLogin&&t.signOut(),e.isAnonymous||(yield st({userType:"anonymousUser"}))}))},getUserInfo:function(e=!1){return c(this,void 0,void 0,(function*(){if(!e&&it.currentUser)return it.currentUser;const t=wx.getStorageSync(ot);return t?!t.lastUpdateTime||Date.now()-t.lastUpdateTime>2592e5?null:(it.currentUser=t,t):t}))},setCurrentUserInfo(e={}){for(const t in e)it.currentUser&&(it.currentUser[t]=e[t])},get currentUser(){return it.currentUser?Object.assign({},it.currentUser):null},getUrlWithOpenidToken:function(e){return c(this,void 0,void 0,(function*(){if(void 0===wx||"function"!=typeof wx.login||!e)return"";const{auth:t}=yield Z();if(!t)return"";const n=t=>{let[n="",r="",o=""]=e.split(/(?:\?|#)+/);return r.startsWith("/")&&(o=r,r=""),`${n}?${r}${r?"&":""}wx_access_token=${t}${o?"#":""}${o}`},{miniProgram:r}=wx.getAccountInfoSync();if(A())return new Promise((e=>{wx.login({success:o=>c(this,void 0,void 0,(function*(){try{const{provider_token:i}=yield t.grantProviderToken({provider_code:o.code,provider_id:null==r?void 0:r.appId}),s=n(i);e(s)}catch(t){console.log("=======> [getUrlWithOpenidToken]: grantProviderToken error ",t),e("")}})),fail:t=>{console.log("=======> [getUrlWithOpenidToken]: wx.login fail ",t),e("")}})}));try{const e=yield ue({action:"GetMiniProgramUserTicket",data:{Type:"externalUser",OnlyOpenId:!0}}),o=(null==e?void 0:e.token)||e;if(!o)return"";const{provider_token:i}=yield t.grantProviderToken({provider_id:null==r?void 0:r.appId,provider_access_token:`${g("envID")} ${o}`});return n(i)}catch(e){}return""}))},openIdLoginInWxApp:function(){return c(this,void 0,void 0,(function*(){if(void 0===wx||"function"!=typeof wx.login)return!1;const{auth:e}=yield tt();if(!e)return!1;let t=!0;const{miniProgram:n}=wx.getAccountInfoSync(),r=null==n?void 0:n.appId,o=yield new Promise(((e,t)=>{wx.login({success:t=>c(this,void 0,void 0,(function*(){e(t.code)})),fail:e=>{console.log("=======> [openIdLoginInWxApp]: wx.login fail ",e);const n=new Error(null==e?void 0:e.errMsg);n.code=null==e?void 0:e.errno,t(n)}})}));try{const i={provider_id:r,provider_params:{provider_code_type:"open_id"}};o&&(i.provider_code=o,i.provider_params.appid=null==n?void 0:n.appId);const{provider_token:s}=yield e.grantProviderToken(i),a=yield e.signInWithProvider({provider_token:s});if(a.code)throw console.log("=======> [openIdLoginInWxApp]: signInWithProvider error ",a),a;t=!0}catch(e){throw console.log("=======> [openIdLoginInWxApp]: error ",e),e}return yield st({userType:"externalUser",force:!0,providerId:r}),t}))},unionIdLoginInWxApp:function(){return c(this,void 0,void 0,(function*(){if(void 0===wx||"function"!=typeof wx.login)return!1;const{auth:e}=yield Z();if(!e){return new Error("auth instance not found")}return new Promise(((t,n)=>{wx.login({success:r=>c(this,void 0,void 0,(function*(){const{miniProgram:o}=wx.getAccountInfoSync(),i=null==o?void 0:o.appId;try{const{provider_token:s}=yield e.grantProviderToken({provider_code:r.code,provider_id:i,provider_params:{provider_code_type:"union_id",appid:null==o?void 0:o.appId}}),a=yield e.signInWithProvider({provider_id:i,provider_token:s});if(a.code)return console.log("=======> [unionIdLoginInWxApp]: signInWithProvider error ",a),void n(a);yield st({userType:"externalUser",force:!0}),t(!0)}catch(e){console.log("=======> [unionIdLoginInWxApp]: error ",e),n(e)}})),fail:e=>{console.log("=======> [unionIdLoginInWxApp]: wx.login fail ",e);const t=new Error(null==e?void 0:e.errMsg);t.code=null==e?void 0:e.errno,n(t)}})}))}))},modifyCurrentUser:function({nickName:e="",userName:t="",avatarUrl:n="",description:r=""}={}){return c(this,void 0,void 0,(function*(){const{userType:o,wedaId:i,nickName:s,avatarUrl:a,userName:c,description:u}=it.currentUser;if("anonymousUser"===o||!i)return{};try{const{auth:l}=yield tt();return yield l.updateUserBasicInfo({user_id:i,nickname:e||s||"",username:t||c||"",description:r||u||"",avatar_url:n||a||""}),yield st({userType:o,force:!0})}catch(e){console.log("=======> [modifyCurrentUser]: error ",e)}return{}}))},judgePasswordFreeLogin:function(){return c(this,void 0,void 0,(function*(){if(void 0!==Ze)return Ze;try{const{auth:e}=yield tt(),{appId:t}=wx.getAccountInfoSync().miniProgram,n=yield e.getProviderSubType({provider_id:t});return Ze="NO_AUTH_LOGIN"===(null==n?void 0:n.provider_sub_type),Ze}catch(e){return console.log("========> judgePasswordFreeLogin error",e),!1}}))}};const ct=Object.assign(_e,at);function ut(){return c(this,void 0,void 0,(function*(){const{app:e,auth:t}=yield tt(),n=yield nt();let r=n.isAnonymous||n.notLogin?"anonymousUser":"externalUser";const{miniProgram:o}=wx.getAccountInfoSync();let i=null==o?void 0:o.appId,s=!0;if("anonymousUser"==r&&(A()&&n.notLogin?yield rt():A()||"openId"===g("__defaultLoginType__")&&(yield at.openIdLoginInWxApp(),s=!1,r="externalUser")),s){const e=e=>{console.warn("[weda-cloud-sdk] failed to sign-in/getUserInfo weda backend",e)};yield at.signIn({userType:r,force:!0,providerId:i}).catch(e)}return e.auth&&(e._auth=e.auth),e.auth=t,{app:e,auth:t}}))}function lt(){return c(this,void 0,void 0,(function*(){return S(ut)}))}Object.defineProperty(ct,"currentUser",{get:()=>at.currentUser}),v({initTcb:lt}),e.CLOUD_API=_e,e.CLOUD_SDK=ct,e.DATASET_CONTEXT=p,e.DS_SDK=Oe,e.EXTRA_API=W,e.OauthClientStorgeBase=C,e.PromiseAllSettled=T,e.TCBError=d,e._generatePrivatelinkAdapter=j,e.callDataSource=ee,e.createDataset=function(e,t,r){v({currentPageId:e});const o=(g("datasetProfiles")||{})[e],i=n.observable({state:{$status:{}},params:{}});if(p[e]=i,!o)return i;const s=Be(o.params,t),a=ze(o.state,{appId:null==r?void 0:r.appId,datasetProfileKey:e});return Object.assign(i.params,s),Object.assign(i.state,a),i},e.createParamsVar=Be,e.createSetDefaultParams=function(e){return t=>{b(e,t)}},e.createStateDataSourceVar=function(e,t){var n,r;return c(this,void 0,void 0,(function*(){const o=null===(n=p[e])||void 0===n?void 0:n.state,i=g("datasetProfiles")||{},s=null===(r=i[e])||void 0===r?void 0:r.state;if(!o||!s)return;Object.keys(s).forEach((n=>c(this,void 0,void 0,(function*(){const r=s[n];if("datasource"===r.varType){if(!r.initMethod||!r.initMethod.name)return o[n]={},void(o.$status[n]={status:"idle"});try{o.$status[r.name]={status:"loading"};const{initMethod:n}=r,i=yield _e.callDataSource({name:r.dataSourceName,methodName:n.name,params:t(n.params,n),options:{showLoading:!0}});q(`${e}.${r.name}`,i)}catch(t){console.error(`[weda-cloud-sdk] 初始化变量 ${e}.${r.name} 失败`,t),q(`${e}.${r.name}`,t)}}}))))}))},e.createStaticStateVar=ze,e.deepClone=E,e.execOnce=S,e.generateOauthClientRequest=k,e.generateParamsParser=function(e){return t=>{if(!t)return t;const n={};return Object.keys(t).forEach((r=>{n[r]=t[r](e.app,e.$page,e.$w)})),n}},e.getAccessToken=function(){return c(this,void 0,void 0,(function*(){const{auth:e}=yield tt();return e.getAccessToken()}))},e.getCommonCloudFnName=y,e.getConfig=g,e.getDataSourceViewId=m,e.getDatasetProfiles=U,e.getDatasourceCloudFnName=function(e){return h.useLegacyDatasource?`lcap-${e.id}-${e.name}${h.isProd?"":"-preview"}`:"lowcode-datasource"+(h.isProd?"":"-preview")},e.getDefaultParams=x,e.getTcbInstance=tt,e.getUrlPath=$,e.hasOwn=f,e.initTcb=lt,e.isObject=D,e.isSameArray=w,e.isString=P,e.pick=O,e.setConfig=v,e.setDatasetProfiles=function(e){v({datasetProfiles:Object.assign(g("datasetProfiles")||{},e)})},e.setDefaultParams=b,e.setLocalDatasetState=function(e,t,n,r){var o,i;const s=Ge(e,t,n);if(s){const a=(null===(o=U(t))||void 0===o?void 0:o.state)||{};if(void 0===r)Ve.delete(s);else{const t=JSON.stringify(r);let o;try{o=JSON.stringify(null===(i=null==a?void 0:a[n])||void 0===i?void 0:i.initialValue)}catch(e){}if(t===o)Ve.delete(s);else try{Ve.set(s,t)}catch(t){if(/exceed storage max size/.test(null==t?void 0:t.message)||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name){(De.getKeysSync()||[]).forEach((t=>{t.startsWith("dataset_")&&!t.startsWith(`dataset_${e}`)&&Promise.resolve().then((()=>{Ve.delete(s)}))}))}else Ve.delete(s);throw t}}}},e.useTcbApi=A,Object.defineProperty(e,"__esModule",{value:!0})}));
